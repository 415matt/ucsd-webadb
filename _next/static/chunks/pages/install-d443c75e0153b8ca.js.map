{"version":3,"file":"static/chunks/pages/install-d443c75e0153b8ca.js","mappings":"oFACA,CAAAA,OAAAC,QAAA,CAAAD,OAAAC,QAAA,MAAAC,IAAA,EACA,WACA,WACA,OAAeC,EAAQ,KACvB,EACA,gDCiBKC,EAALA,+HAAKA,EAAAA,EAAAA,GAAAA,CAAAA,EAAAA,CAAAA,CAAAA,EAAAA,CAAAA,EACDC,SAAAA,CAAAA,EAAAA,CAAAA,YADCD,CAAAA,CAAAA,EAGDE,UAAAA,CAAAA,EAAAA,CAAAA,aAHCF,CAAAA,CAAAA,EAKDG,SAAAA,CAAAA,EAAAA,CAAAA,YAiHJ,IAAMC,EAAQ,IAlGd,MAWIC,aAAc,MAVdC,UAAAA,CAAa,QAEbC,QAAAA,CAAiCC,KAAAA,OAEjCC,GAAAA,CAAc,QAEdC,OAAAA,CAAiD,CAC7CC,wBAAyB,EAC7B,OAUAC,OAAAA,CAAU,SAAY,CAClB,IAAMC,EAAO,MAAMC,CAAAA,EAAAA,EAAAA,EAAAA,EAAS,CAAEC,OAAQ,MAAO,GAC7C,GAAI,CAACF,EACD,MACH,CAEDG,CAAAA,EAAAA,EAAAA,CAAAA,EAAY,IAAM,CACd,IAAI,CAACV,UAAU,CAAG,GAClB,IAAI,CAACC,QAAQ,CAAG,CACZU,SAAUJ,EAAKK,IAAI,CACnBC,MAAOnB,EAAMC,SAAS,CACtBmB,aAAc,EACdC,UAAWR,EAAKS,IAAI,CACpBC,MAAO,CACX,EACA,IAAI,CAACd,GAAG,CAAG,EACf,GAEA,IAAMe,EAAK,IAAIC,EAAAA,EAAcA,CAACC,EAAAA,CAAAA,CAAAA,GAAgB,EACxCC,EAAQC,KAAKC,GAAG,GAChBpB,EAAM,MAAMe,EAAGM,aAAa,CAC9BjB,EAAKS,IAAI,CACTS,CAAAA,EAAAA,EAAAA,EAAAA,EAAiBlB,GACZmB,WAAW,CAAC,IAAIC,EAAAA,oBAAoBA,EACpCD,WAAW,CACR,IAAIE,EAAAA,EAAcA,CACdC,CAAAA,EAAAA,EAAAA,EAAAA,EAAO,GAAc,CACbC,IAAavB,EAAKS,IAAI,CACtB,IAAI,CAACf,QAAQ,CAAG,CACZU,SAAUJ,EAAKK,IAAI,CACnBC,MAAOnB,EAAMC,SAAS,CACtBmB,aAAcgB,EACdf,UAAWR,EAAKS,IAAI,CACpBC,MAAOa,EAAYvB,EAAKS,IAAI,CAAI,EACpC,EAEA,IAAI,CAACf,QAAQ,CAAG,CACZU,SAAUJ,EAAKK,IAAI,CACnBC,MAAOnB,EAAME,UAAU,CACvBkB,aAAcgB,EACdf,UAAWR,EAAKS,IAAI,CACpBC,MAAO,EACX,CAER,MAKVc,EAAUT,KAAKC,GAAG,GAAKF,CAC7B,OAAMlB,EAAI6B,MAAM,CACZ,IAAIC,EAAAA,cAAcA,CAAC,CACfC,MAAOL,CAAAA,EAAAA,EAAAA,EAAAA,EAAO,GAAW,CACrB,IAAI,CAAC1B,GAAG,EAAIgC,CAChB,EACJ,IAGJ,IAAMC,EAAe,CACjB7B,EAAKS,IAAI,CACRe,CAAAA,EAAU,KACX,KACA,MACFM,OAAO,CAAC,EACV,KAAI,CAAClC,GAAG,EAAI,uBAAuCiC,MAAAA,CAAhBL,EAAQ,UAAqBO,MAAA,CAAbF,EAAa,QAEhE1B,CAAAA,EAAAA,EAAAA,CAAAA,EAAY,IAAM,CACd,IAAI,CAACT,QAAQ,CAAG,CACZU,SAAUJ,EAAKK,IAAI,CACnBC,MAAOnB,EAAMG,SAAS,CACtBiB,aAAcP,EAAKS,IAAI,CACvBD,UAAWR,EAAKS,IAAI,CACpBC,MAAO,CACX,EACA,IAAI,CAACjB,UAAU,CAAG,EACtB,EACJ,EAnFIuC,CAAAA,EAAAA,EAAAA,EAAAA,EAAmB,IAAI,CAAE,CACrBtC,SAAUuC,EAAAA,EAAAA,CAAAA,GAAc,CACxBlC,QAAS,GACTF,QAASoC,EAAAA,EAAAA,CAAAA,IAAe,EAEhC,CA+EJ,EAIMC,EAAoB,IAElB,GAAAC,EAAAC,IAAA,EAACC,EAAAA,CAAKA,CAAAA,CAAE,GAAGC,EAAAA,EAAe,WACtB,GAAAH,EAAAI,GAAA,EAACC,IAAIA,UACD,GAAAL,EAAAI,GAAA,EAACE,QAAAA,UAAM,0BAGX,GAAAN,EAAAI,GAAA,EAACF,EAAAA,CAAKA,CAAAA,CAACK,WAAU,YACb,GAAAP,EAAAI,GAAA,EAACI,EAAAA,CAAQA,CAAAA,CACLC,MAAM,6CACNC,QAAStD,EAAMM,OAAO,CAACC,uBAAuB,CAC9CgD,SAAU,CAACC,EAAGF,IAAY,CACNlD,KAAAA,IAAZkD,GAGJ1C,CAAAA,EAAAA,EAAAA,CAAAA,EAAY,IAAM,CACdZ,EAAMM,OAAO,CAACC,uBAAuB,CAAG+C,CAC5C,EACJ,MAIR,GAAAV,EAAAI,GAAA,EAACF,EAAAA,CAAKA,CAAAA,CAACK,WAAU,YACb,GAAAP,EAAAI,GAAA,EAACS,EAAAA,CAAaA,CAAAA,CACVC,SAAU,CAACpC,EAAAA,CAAAA,CAAAA,GAAgB,EAAItB,EAAME,UAAU,CAC/CyD,KAAK,aACLC,QAAS5D,EAAMQ,OAAO,KAI7BR,EAAMG,QAAQ,EACX,GAAAyC,EAAAI,GAAA,EAACa,EAAAA,CAAiBA,CAAAA,CACdC,OAAQ,CAAEC,KAAM,CAAEC,MAAO,GAAI,CAAE,EAC/BX,MAAOrD,EAAMG,QAAQ,CAACU,QAAQ,CAC9BoD,gBAAiBjE,EAAMG,QAAQ,CAACgB,KAAK,CACrC+C,YAAatE,CAAK,CAACI,EAAMG,QAAQ,CAACY,KAAK,CAAC,GAI/Cf,EAAMK,GAAG,EAAI,GAAAuC,EAAAI,GAAA,EAACmB,MAAAA,UAAKnE,EAAMK,GAAG,KAKzC+D,CAAAA,EAAA,QAAeC,CAAAA,EAAAA,EAAAA,EAAAA,EAAS1B","sources":["webpack://_N_E/?0be5","webpack://_N_E/./src/pages/install.tsx","webpack://_N_E/<anon>"],"sourcesContent":["\n    (window.__NEXT_P = window.__NEXT_P || []).push([\n      \"/install\",\n      function () {\n        return require(\"private-next-pages/install.tsx\");\n      }\n    ]);\n    if(module.hot) {\n      module.hot.dispose(function () {\n        window.__NEXT_P.push([\"/install\"])\n      });\n    }\n  ","import {\r\n    Checkbox,\r\n    PrimaryButton,\r\n    ProgressIndicator,\r\n    Stack,\r\n} from \"@fluentui/react\";\r\nimport {\r\n    PackageManager,\r\n    PackageManagerInstallOptions,\r\n} from \"@yume-chan/android-bin\";\r\nimport { WrapConsumableStream, WritableStream } from \"@yume-chan/stream-extra\";\r\nimport { action, makeAutoObservable, observable, runInAction } from \"mobx\";\r\nimport { observer } from \"mobx-react-lite\";\r\nimport { NextPage } from \"next\";\r\nimport Head from \"next/head\";\r\nimport { GLOBAL_STATE } from \"../state\";\r\nimport {\r\n    ProgressStream,\r\n    RouteStackProps,\r\n    createFileStream,\r\n    pickFile,\r\n} from \"../utils\";\r\n\r\nenum Stage {\r\n    Uploading,\r\n\r\n    Installing,\r\n\r\n    Completed,\r\n}\r\n\r\ninterface Progress {\r\n    filename: string;\r\n\r\n    stage: Stage;\r\n\r\n    uploadedSize: number;\r\n\r\n    totalSize: number;\r\n\r\n    value: number | undefined;\r\n}\r\n\r\nclass InstallPageState {\r\n    installing = false;\r\n\r\n    progress: Progress | undefined = undefined;\r\n\r\n    log: string = \"\";\r\n\r\n    options: Partial<PackageManagerInstallOptions> = {\r\n        bypassLowTargetSdkBlock: false,\r\n    };\r\n\r\n    constructor() {\r\n        makeAutoObservable(this, {\r\n            progress: observable.ref,\r\n            install: false,\r\n            options: observable.deep,\r\n        });\r\n    }\r\n\r\n    install = async () => {\r\n        const file = await pickFile({ accept: \".apk\" });\r\n        if (!file) {\r\n            return;\r\n        }\r\n\r\n        runInAction(() => {\r\n            this.installing = true;\r\n            this.progress = {\r\n                filename: file.name,\r\n                stage: Stage.Uploading,\r\n                uploadedSize: 0,\r\n                totalSize: file.size,\r\n                value: 0,\r\n            };\r\n            this.log = \"\";\r\n        });\r\n\r\n        const pm = new PackageManager(GLOBAL_STATE.adb!);\r\n        const start = Date.now();\r\n        const log = await pm.installStream(\r\n            file.size,\r\n            createFileStream(file)\r\n                .pipeThrough(new WrapConsumableStream())\r\n                .pipeThrough(\r\n                    new ProgressStream(\r\n                        action((uploaded) => {\r\n                            if (uploaded !== file.size) {\r\n                                this.progress = {\r\n                                    filename: file.name,\r\n                                    stage: Stage.Uploading,\r\n                                    uploadedSize: uploaded,\r\n                                    totalSize: file.size,\r\n                                    value: (uploaded / file.size) * 0.8,\r\n                                };\r\n                            } else {\r\n                                this.progress = {\r\n                                    filename: file.name,\r\n                                    stage: Stage.Installing,\r\n                                    uploadedSize: uploaded,\r\n                                    totalSize: file.size,\r\n                                    value: 0.8,\r\n                                };\r\n                            }\r\n                        })\r\n                    )\r\n                )\r\n        );\r\n\r\n        const elapsed = Date.now() - start;\r\n        await log.pipeTo(\r\n            new WritableStream({\r\n                write: action((chunk) => {\r\n                    this.log += chunk;\r\n                }),\r\n            })\r\n        );\r\n\r\n        const transferRate = (\r\n            file.size /\r\n            (elapsed / 1000) /\r\n            1024 /\r\n            1024\r\n        ).toFixed(2);\r\n        this.log += `Install finished in ${elapsed}ms at ${transferRate}MB/s`;\r\n\r\n        runInAction(() => {\r\n            this.progress = {\r\n                filename: file.name,\r\n                stage: Stage.Completed,\r\n                uploadedSize: file.size,\r\n                totalSize: file.size,\r\n                value: 1,\r\n            };\r\n            this.installing = false;\r\n        });\r\n    };\r\n}\r\n\r\nconst state = new InstallPageState();\r\n\r\nconst Install: NextPage = () => {\r\n    return (\r\n        <Stack {...RouteStackProps}>\r\n            <Head>\r\n                <title>Install APK - Tango</title>\r\n            </Head>\r\n\r\n            <Stack horizontal>\r\n                <Checkbox\r\n                    label=\"--bypass-low-target-sdk-block (Android 14)\"\r\n                    checked={state.options.bypassLowTargetSdkBlock}\r\n                    onChange={(_, checked) => {\r\n                        if (checked === undefined) {\r\n                            return;\r\n                        }\r\n                        runInAction(() => {\r\n                            state.options.bypassLowTargetSdkBlock = checked;\r\n                        });\r\n                    }}\r\n                />\r\n            </Stack>\r\n\r\n            <Stack horizontal>\r\n                <PrimaryButton\r\n                    disabled={!GLOBAL_STATE.adb || state.installing}\r\n                    text=\"Browse APK\"\r\n                    onClick={state.install}\r\n                />\r\n            </Stack>\r\n\r\n            {state.progress && (\r\n                <ProgressIndicator\r\n                    styles={{ root: { width: 300 } }}\r\n                    label={state.progress.filename}\r\n                    percentComplete={state.progress.value}\r\n                    description={Stage[state.progress.stage]}\r\n                />\r\n            )}\r\n\r\n            {state.log && <pre>{state.log}</pre>}\r\n        </Stack>\r\n    );\r\n};\r\n\r\nexport default observer(Install);\r\n"],"names":["window","__NEXT_P","push","__webpack_require__","Stage","Uploading","Installing","Completed","state","constructor","installing","progress","undefined","log","options","bypassLowTargetSdkBlock","install","file","pickFile","accept","runInAction","filename","name","stage","uploadedSize","totalSize","size","value","pm","PackageManager","GLOBAL_STATE","start","Date","now","installStream","createFileStream","pipeThrough","WrapConsumableStream","ProgressStream","action","uploaded","elapsed","pipeTo","WritableStream","write","chunk","transferRate","toFixed","concat","makeAutoObservable","observable","Install","react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__","jsxs","Stack","RouteStackProps","jsx","Head","title","horizontal","Checkbox","label","checked","onChange","_","PrimaryButton","disabled","text","onClick","ProgressIndicator","styles","root","width","percentComplete","description","pre","__webpack_exports__","observer"],"sourceRoot":""}